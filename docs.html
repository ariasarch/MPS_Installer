<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MPS â€“ Documentation</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/png" href="neumaierlabdesign.png" />
  <link rel="apple-touch-icon" href="neumaierlabdesign.png" />
  <style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Inter','Helvetica Neue',Arial,sans-serif}
    body{background:#000;color:#fff;min-height:100vh;display:flex;flex-direction:column;align-items:center}
    .container{max-width:1000px;width:100%;padding:20px}
    .header{text-align:center;padding:40px 0 10px}
    .logo-image{max-width:220px;width:100%;height:auto}
    .nav-tabs{display:flex;justify-content:center;gap:10px;margin:20px 0 30px;border-bottom:2px solid #2a2a2a}
    .nav-tab{padding:12px 24px;background:transparent;color:#a9a9a9;border:none;border-bottom:2px solid transparent;cursor:pointer;font-size:16px;font-weight:500;transition:.3s;margin-bottom:-2px;text-decoration:none;display:inline-block}
    .nav-tab:hover{color:#fff;background:#1a1a1a}
    .nav-tab.active{color:#fff;border-bottom-color:#fff}
    .section{margin:40px 0}
    .section-title{font-size:32px;margin-bottom:20px;color:#fff;position:relative;display:inline-block;font-weight:600}
    .section-title:after{content:'';position:absolute;left:0;bottom:-8px;width:50px;height:3px;background:#444}

    .doc-container{background:#1a1a1a;border-radius:16px;padding:40px;margin:20px 0;border:1px solid #2a2a2a}
    .doc-toc{background:#1a1a1a;border:1px solid #2a2a2a;border-radius:12px;padding:30px;margin:30px 0}
    .doc-toc h3{color:#fff;margin-bottom:20px;font-size:24px}
    .doc-toc ul{list-style:none;padding-left:0}
    .doc-toc li{padding:8px 0}
    .doc-toc a{color:#4a9eff;text-decoration:none}
    .doc-toc a:hover{text-decoration:underline;color:#6ab7ff}

    .doc-section{margin:40px 0;padding:30px;background:#1a1a1a;border-radius:12px;border:1px solid #2a2a2a}
    .doc-section h3{color:#fff;font-size:28px;margin-bottom:20px;font-weight:600}
    .doc-section h4{color:#fff;font-size:22px;margin:30px 0 15px;font-weight:600}
    .doc-section h5{color:#fff;font-size:18px;margin:20px 0 10px;font-weight:600}
    .doc-section p{color:#ccc;line-height:1.8;margin-bottom:15px}
    .doc-section ul,.doc-section ol{color:#ccc;line-height:1.8;margin:15px 0;padding-left:30px}
    .doc-section li{margin:8px 0}

    .parameter-box{background:#0a0a0a;border:1px solid #333;border-radius:8px;padding:20px;margin:15px 0}
    .parameter-box strong{color:#4a9eff}
    .tip-box{background:#1a2a1a;border:1px solid #2a4a2a;border-left:4px solid #4a9eff;padding:20px;margin:20px 0;border-radius:8px}
    .code-block{background:#000;border:1px solid #2a2a2a;border-radius:8px;padding:20px;font-family:Consolas,Monaco,monospace;font-size:14px;color:#ccc;overflow-x:auto;margin:20px 0}
    .warning-box{background:#2a2a2a;border:1px solid #444;color:#f0f0f0;padding:20px;border-radius:8px;margin:20px auto;max-width:820px}

    footer{margin-top:auto;width:100%;background:#000;padding:30px 0;text-align:center;border-top:1px solid #2a2a2a}
    .footer-content{max-width:1000px;margin:0 auto;padding:0 20px}
    .footer-links{display:flex;justify-content:center;gap:30px;margin-bottom:20px;flex-wrap:wrap}
    .footer-link{color:#a9a9a9;text-decoration:none}
    .footer-link:hover{color:#fff}
    .footer-text{font-size:14px;color:#666;margin-top:20px}
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <img src="neumaierlabdesign.png" alt="MPS" class="logo-image" />
    </header>

    <nav class="nav-tabs">
      <a class="nav-tab" href="index.html">Overview</a>
      <a class="nav-tab active" href="docs.html">Documentation</a>
      <a class="nav-tab" href="installation.html">Installation</a>
      <a class="nav-tab" href="resources.html">Resources</a>
    </nav>

    <!-- ===== Your long documentation (unchanged content, formatted) ===== -->
    <section class="section">
      <h2 class="section-title">ðŸ“š Miniscope Processing Pipeline Guide</h2>

      <div class="doc-container">
        <h3>Overview</h3>
        <p>This guide walks through the complete miniscope calcium imaging processing pipeline.</p>

        <h3>Quick Start</h3>
        <ol>
          <li><strong>Initial Setup</strong>
            <ul>
              <li>Install and launch MPS (Windows installer or macOS app)</li>
            </ul>
          </li>
          <li><strong>Loading Data</strong>
            <ul>
              <li><strong>New Analysis</strong>: Start at Step 1 (Project Configuration)</li>
              <li><strong>Existing Analysis</strong>:
                <ul>
                  <li>File â†’ Load parameters file</li>
                  <li>Load previous data and choose the step to resume</li>
                  <li>Automation â†’ Toggle / Run (all or from current)</li>
                </ul>
              </li>
            </ul>
          </li>
        </ol>

        <div class="warning-box" style="margin-top:30px">
          <strong>License:</strong> Licensed under the Apache License, Version 2.0 (the "License"); you may not use this file except in compliance with the License. You may obtain a copy of the License at <a href="http://www.apache.org/licenses/LICENSE-2.0" style="color:#4a9eff;text-decoration:none">http://www.apache.org/licenses/LICENSE-2.0</a>
        </div>
      </div>

      <div class="doc-toc">
        <h3>Table of Contents</h3>
        <ul>
          <li><a href="#getting-started">Getting Started</a></li>
          <li><a href="#pipeline-steps">Pipeline Steps</a></li>
          <li><a href="#tips">Tips and Best Practices</a></li>
          <li><a href="#issues">Common Issues and Solutions</a></li>
          <li><a href="#interpreting">Interpreting Your Results</a></li>
          <li><a href="#advanced">Advanced Features</a></li>
        </ul>
      </div>

      <div id="getting-started" class="doc-section">
        <h3>Getting Started</h3>
        <h4>Initial Setup</h4>
        <p>Launch MPS from the installer-created shortcut (Windows) or the app bundle (macOS).</p>
        <h4>Load Data</h4>
        <ul>
          <li>File â†’ Load parameters file (optional)</li>
          <li>Enable automation to run multi-step pipelines unattended</li>
          <li>Resume from previous cache by selecting the directory and target step</li>
        </ul>
      </div>

      <!-- === Huge steps content preserved from your original === -->
      <!-- For brevity here, the following sections include the same text you provided. -->
      <div id="pipeline-steps" class="doc-section">
        <h3>Pipeline Steps</h3>

        <div id="step-1" class="parameter-box">
          <h4>Step 1: Project Configuration</h4>
          <p><strong>Required inputs:</strong></p>
          <ul>
            <li>Animal ID</li><li>Session ID</li><li>Input directory</li><li>Output directory</li>
          </ul>
          <p><strong>Advanced:</strong> Dask workers (8), memory limits, % of video for tests.</p>
        </div>

        <div id="step-2" class="parameter-box">
          <h4>Step 2: Data Preprocessing</h4>

          <h5>2a: File Pattern Recognition</h5>
          <ul>
            <li>Regex for your video files (.avi default works)</li>
            <li>Use an LLM to draft regex from an example path</li>
          </ul>

          <h5>2b: Background Removal & Denoising</h5>
          <p><strong>Denoising:</strong> Median, Gaussian, Bilateral, Anisotropic (trade speed/edges).</p>
          <p><strong>Background:</strong> Tophat (robust), Uniform (fast/simple).</p>

          <h5>2c: Motion Correction</h5>
          <ul>
            <li>"frame" mode; expect high RAM usage</li>
            <li>Recursive phase correlation</li>
          </ul>

          <h5>2d: Quality Control</h5>
          <ul><li>Threshold factor: SDs above mean to drop frames</li></ul>

          <h5>2e: Data Validation</h5>
          <ul><li>Keep fill=0; validate transformed data</li></ul>

          <h5>2f: Preview Results</h5>
          <ul><li>Subset check; saves only stats</li></ul>
        </div>

        <div id="step-3" class="parameter-box">
          <h4>Step 3: Spatial Cropping & Initialization</h4>
          <h5>3a: ROI</h5>
          <ul>
            <li>Keep crop tight; test on 10% data first</li>
          </ul>
          <h5>3b: NNDSVD Initialization</h5>
          <ul>
            <li>Components, power iters, sparsity, reg, chunk size</li>
          </ul>
          <h5>3c: Early Analysis Option</h5>
          <p>Some workflows stop here for prelim results.</p>
        </div>

        <div id="step-4" class="parameter-box">
          <h4>Step 4: Component Detection</h4>
          <h5>4a: Watershed Search</h5>
          <ul>
            <li>Min distances, threshold relativity, sigma values, sample size</li>
          </ul>
          <h5>4b: Apply Best Params</h5>
          <h5>4c: Merging Units</h5>
          <h5>4d: Temporal Extraction</h5>
          <h5>4e: AC Initialization</h5>
          <h5>4f: Final Component Prep</h5>
          <h5>4g: Temporal Merging</h5>
        </div>

        <div id="step-5" class="parameter-box">
          <h4>Step 5: CNMF Preparation</h4>
          <h5>5a: Noise Estimation</h5>
          <h5>5b: Validation & Setup</h5>
        </div>

        <div id="step-6" class="parameter-box">
          <h4>Step 6: CNMF Processing</h4>
          <h5>6a: YrA Computation</h5>
          <h5>6b: YrA Validation</h5>
          <h5>6c: Parameter Suggestion</h5>
          <h5>6d: Update Temporal Components</h5>
          <h5>6e: Filter & Validate</h5>
        </div>

        <div id="step-7" class="parameter-box">
          <h4>Step 7: Spatial Refinement</h4>
          <h5>7a: Dilation</h5>
          <h5>7b: Clustering</h5>
          <h5>7c: Bounds</h5>
          <h5>7d: Suggestions</h5>
          <h5>7e: Spatial Update</h5>
          <h5>7f: Merging & Validation</h5>
        </div>

        <div id="step-8" class="parameter-box">
          <h4>Step 8: Final Processing & Export</h4>
          <h5>8a: YrA</h5>
          <h5>8b: Final Temporal Update</h5>
          <h5>8c: Filtering & Export (Zarr/NumPy/JSON/Pickle)</h5>
        </div>
      </div>

      <div id="tips" class="doc-section">
        <h3>Tips & Best Practices</h3>
        <ol>
          <li>Start small (10% data)</li><li>Monitor memory</li><li>Autosave</li>
          <li>Check intermediate steps (2f, 6b)</li><li>Over-segment then merge</li>
          <li>Use temporal chunking for long videos</li>
        </ol>
      </div>

      <div id="issues" class="doc-section">
        <h3>Common Issues & Solutions</h3>
        <h4>Memory errors in YrA</h4><ul><li>Smaller batches; float32; raise dask memory</li></ul>
        <h4>Fragmented components</h4><ul><li>Lower penalties; lower min-STD</li></ul>
        <h4>Too many spurious units</h4><ul><li>Increase min size; conservative thresholds</li></ul>
        <h4>Noisy traces</h4><ul><li>AR p=2; higher sparse penalty; verify noise map</li></ul>
      </div>

      <div id="interpreting" class="doc-section">
        <h3>Interpreting Results</h3>
        <p>Review A (spatial), C (calcium), S (spikes), QC metrics. Cross-check against videos.</p>
      </div>

      <div id="advanced" class="doc-section">
        <h3>Advanced Features</h3>

        <h4>Line Splitting Detection</h4>
        <div class="code-block">import numpy as np
def detect_line_splitting_frames(xarray_data):
    left_edge = xarray_data.isel(width=slice(0, 20))
    left_edge_means = left_edge.mean(dim=['height','width']).compute()
    overall_mean = left_edge_means.mean().item()
    overall_std = left_edge_means.std().item()
    threshold = overall_mean + 2 * overall_std
    return np.where(left_edge_means > threshold)[0].tolist()</div>

        <h4>Automation</h4>
        <ul>
          <li>Automation â†’ Toggle Autorun / Run All / Run From Current</li>
          <li>Save & load parameter files between datasets</li>
        </ul>
      </div>
    </section>
  </div>

  <footer>
    <div class="footer-content">
      <div class="footer-links">
        <a class="footer-link" href="https://github.com/ariasarch/MPS_Installer">GitHub Repository</a>
        <a class="footer-link" href="https://github.com/ariasarch/MPS_Installer/issues">Report Issues</a>
        <a class="footer-link" href="installation.html">Installation</a>
      </div>
      <p class="footer-text">
        Â© 2024 Neumaier Lab â€¢ MPS â€“ Miniscope Processing Suite â€¢ Use requires attribution â€” see
        <a class="footer-link" href="LICENSE">License</a>
      </p>
    </div>
  </footer>
</body>
</html>
